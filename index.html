<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#059669">
    <title>Prayer Times</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { overscroll-behavior: none; }
    </style>
</head>
<body class="bg-gradient-to-br from-emerald-50 to-teal-100 min-h-screen">
    <div id="app"></div>

    <script>
        // ATHAN AUDIO - Replace with your Base64 encoded MP3 file
        const athanAudio = 'data:audio/mp3;base64,YOUR_ATHAN_BASE64_HERE';

        // Main App State
        let state = {
            currentTime: new Date(),
            nextPrayer: null,
            selectedMethod: 'mwl',
            showMethodMenu: false,
            prayerTimes: null,
            location: { name: 'Cape Town, South Africa', lat: -33.9249, lon: 18.4241 },
            editingLocation: false,
            locationInput: '',
            detectingLocation: false,
            notificationsEnabled: true,
            lastAthanPlayed: null
        };

        const prayers = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];

        const calculationMethods = {
            'mwl': { name: 'Muslim World League', fajr: 18, isha: 17 },
            'isna': { name: 'Islamic Society of North America', fajr: 15, isha: 15 },
            'egypt': { name: 'Egyptian General Authority', fajr: 19.5, isha: 17.5 },
            'makkah': { name: 'Umm Al-Qura, Makkah', fajr: 18.5, isha: '90 min' },
            'karachi': { name: 'University of Islamic Sciences, Karachi', fajr: 18, isha: 18 }
        };

        function loadSavedLocation() {
            try {
                const saved = localStorage.getItem('prayer-location');
                if (saved) state.location = JSON.parse(saved);
                const notifPref = localStorage.getItem('notifications-enabled');
                if (notifPref !== null) state.notificationsEnabled = notifPref === 'true';
                const lastAthan = localStorage.getItem('last-athan');
                if (lastAthan) state.lastAthanPlayed = lastAthan;
            } catch (e) {
                console.log('Could not load saved settings');
            }
        }

        function saveLocation(loc) {
            try {
                localStorage.setItem('prayer-location', JSON.stringify(loc));
            } catch (e) {
                console.log('Could not save location');
            }
        }

        function toggleNotifications() {
            state.notificationsEnabled = !state.notificationsEnabled;
            localStorage.setItem('notifications-enabled', state.notificationsEnabled);
            render();
        }

        function detectLocation() {
            state.detectingLocation = true;
            render();
            
            if ('geolocation' in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        state.location = {
                            name: `${position.coords.latitude.toFixed(4)}¬∞, ${position.coords.longitude.toFixed(4)}¬∞`,
                            lat: position.coords.latitude,
                            lon: position.coords.longitude
                        };
                        saveLocation(state.location);
                        state.detectingLocation = false;
                        calculatePrayerTimes();
                        render();
                    },
                    (error) => {
                        alert('Could not detect location. Please enter manually.');
                        state.detectingLocation = false;
                        render();
                    }
                );
            } else {
                alert('Geolocation not supported');
                state.detectingLocation = false;
                render();
            }
        }

        function handleManualLocation() {
            if (!state.locationInput.trim()) return;
            const coords = state.locationInput.match(/(-?\d+\.?\d*)[,\s]+(-?\d+\.?\d*)/);
            if (coords) {
                state.location = {
                    name: state.locationInput,
                    lat: parseFloat(coords[1]),
                    lon: parseFloat(coords[2])
                };
                saveLocation(state.location);
                state.editingLocation = false;
                state.locationInput = '';
                calculatePrayerTimes();
                render();
            } else {
                alert('Enter: latitude, longitude (e.g., -33.9249, 18.4241)');
            }
        }

        function playReminder() {
            if (reminderAudio.includes('YOUR_')) {
                playGeneratedSound('reminder');
                return;
            }
            const audio = new Audio(reminderAudio);
            audio.volume = 0.8;
            audio.play().catch(() => playGeneratedSound('reminder'));
        }

        function playAthan() {
            if (athanAudio.includes('YOUR_')) {
                playGeneratedSound();
                return;
            }
            const audio = new Audio(athanAudio);
            audio.volume = 0.8;
            audio.play().catch(() => playGeneratedSound());
        }

        function playIqama() {
            if (iqamaAudio.includes('YOUR_')) {
                playGeneratedSound('iqama');
                return;
            }
            const audio = new Audio(iqamaAudio);
            audio.volume = 0.8;
            audio.play().catch(() => playGeneratedSound('iqama'));
        }

        function playGeneratedSound(type) {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            let melody;
            if (type === 'reminder') {
                melody = [{f:523.25,d:0.3},{f:659.25,d:0.3},{f:523.25,d:0.3}]; // Quick beeps
            } else if (type === 'iqama') {
                melody = [{f:659.25,d:0.3},{f:587.33,d:0.3},{f:523.25,d:0.5}]; // Short iqama
            } else {
                melody = [{f:523.25,d:0.8},{f:587.33,d:0.6},{f:659.25,d:1.0},{f:587.33,d:0.8},{f:523.25,d:1.2},
                         {f:0,d:0.3},{f:523.25,d:0.8},{f:587.33,d:0.6},{f:659.25,d:1.0},{f:587.33,d:0.8},
                         {f:523.25,d:1.2},{f:0,d:0.4},{f:493.88,d:0.7},{f:523.25,d:0.7},{f:587.33,d:0.9},{f:659.25,d:1.3}];
            }
            let t = ctx.currentTime;
            melody.forEach(n => {
                if (n.f > 0) {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.frequency.value = n.f;
                    osc.type = 'sine';
                    gain.gain.setValueAtTime(0, t);
                    gain.gain.linearRampToValueAtTime(0.4, t + 0.05);
                    gain.gain.exponentialRampToValueAtTime(0.01, t + n.d - 0.05);
                    osc.start(t);
                    osc.stop(t + n.d);
                }
                t += n.d;
            });
        }

        function calculatePrayerTimes() {
            const date = new Date();
            const start = new Date(date.getFullYear(), 0, 0);
            const dayOfYear = Math.floor((date - start) / (1000 * 60 * 60 * 24));
            
            const B = (360 / 365) * (dayOfYear - 81) * Math.PI / 180;
            const EoT = 9.87 * Math.sin(2 * B) - 7.53 * Math.cos(B) - 1.5 * Math.sin(B);
            const declination = 23.45 * Math.sin((360 / 365) * (dayOfYear + 284) * Math.PI / 180);
            const timezoneOffset = -date.getTimezoneOffset() / 60;
            const dhuhr = 12 + timezoneOffset - (state.location.lon / 15) - (EoT / 60);
            
            const hourAngle = (angle) => {
                const lat = state.location.lat * Math.PI / 180;
                const dec = declination * Math.PI / 180;
                const ang = angle * Math.PI / 180;
                const cosH = (Math.cos(ang) - Math.sin(lat) * Math.sin(dec)) / (Math.cos(lat) * Math.cos(dec));
                if (cosH > 1 || cosH < -1) return 0;
                return Math.acos(cosH) * 180 / Math.PI / 15;
            };
            
            const fajrHA = hourAngle(90 + calculationMethods[state.selectedMethod].fajr);
            const maghribHA = hourAngle(90.833);
            const asrHA = hourAngle(90 - Math.atan(1 + Math.tan(Math.abs(state.location.lat - declination) * Math.PI / 180)) * 180 / Math.PI);
            
            const fajr = dhuhr - fajrHA;
            const asr = dhuhr + asrHA;
            const maghrib = dhuhr + maghribHA;
            const isha = state.selectedMethod === 'makkah' ? maghrib + 1.5 : dhuhr + hourAngle(90 + calculationMethods[state.selectedMethod].isha);
            
            state.prayerTimes = {
                Fajr: formatTime(fajr),
                Dhuhr: formatTime(dhuhr),
                Asr: formatTime(asr),
                Maghrib: formatTime(maghrib),
                Isha: formatTime(isha)
            };
        }

        function formatTime(time) {
            while (time < 0) time += 24;
            while (time >= 24) time -= 24;
            let h = Math.floor(time);
            let m = Math.round((time - h) * 60);
            if (m >= 60) { h += 1; m -= 60; }
            if (h >= 24) h -= 24;
            return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
        }

        function calculateNextPrayer() {
            if (!state.prayerTimes) return;
            const now = state.currentTime;
            const currentMin = now.getHours() * 60 + now.getMinutes();
            
            for (let prayer of prayers) {
                const [h, m] = state.prayerTimes[prayer].split(':');
                const prayerMin = parseInt(h) * 60 + parseInt(m);
                if (prayerMin > currentMin) {
                    const diff = prayerMin - currentMin;
                    state.nextPrayer = {
                        name: prayer,
                        time: state.prayerTimes[prayer],
                        hoursLeft: Math.floor(diff / 60),
                        minutesLeft: diff % 60
                    };
                    return;
                }
            }
            
            const [h, m] = state.prayerTimes['Fajr'].split(':');
            const fajrMin = parseInt(h) * 60 + parseInt(m);
            const diff = (24 * 60 - currentMin) + fajrMin;
            state.nextPrayer = {
                name: 'Fajr',
                time: state.prayerTimes['Fajr'],
                hoursLeft: Math.floor(diff / 60),
                minutesLeft: diff % 60
            };
        }

        function checkPrayerTime() {
            if (!state.prayerTimes || !state.notificationsEnabled) return;
            const now = state.currentTime;
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            const sec = now.getSeconds();
            
            // Only check at the start of each minute
            if (sec >= 0 && sec <= 2) {
                for (let prayer of prayers) {
                    const [h, m] = state.prayerTimes[prayer].split(':');
                    const prayerHour = parseInt(h);
                    const prayerMinute = parseInt(m);
                    
                    // Check if it's prayer time
                    if (currentHour === prayerHour && currentMinute === prayerMinute) {
                        const athanKey = `${now.toDateString()}-${prayer}`;
                        if (state.lastAthanPlayed !== athanKey) {
                            state.lastAthanPlayed = athanKey;
                            localStorage.setItem('last-athan', athanKey);
                            
                            // Play Athan
                            playAthan();
                            
                            // Show notification
                            if ('Notification' in window && Notification.permission === 'granted') {
                                new Notification(`üïå ${prayer} Prayer Time`, {
                                    body: `It's time for ${prayer} prayer`,
                                    tag: prayer,
                                    requireInteraction: true
                                });
                            }
                        }
                    }
                }
            }
        }

        function display12Hour(time) {
            const [h, m] = time.split(':');
            const hour = parseInt(h);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const h12 = hour > 12 ? hour - 12 : hour === 0 ? 12 : hour;
            return `${h12}:${m} ${ampm}`;
        }

        function render() {
            if (!state.prayerTimes) {
                document.getElementById('app').innerHTML = '<div class="min-h-screen flex items-center justify-center"><div class="text-emerald-700 text-xl">Calculating...</div></div>';
                return;
            }

            document.getElementById('app').innerHTML = `
                <div class="max-w-2xl mx-auto p-4">
                    <div class="text-center mb-8 pt-8">
                        <h1 class="text-4xl font-bold text-emerald-800 mb-2">Prayer Times</h1>
                        
                        <div class="flex items-center justify-center text-emerald-600 gap-2 mb-2">
                            üìç
                            ${state.editingLocation ? `
                                <input type="text" id="locInput" value="${state.locationInput}" placeholder="lat, lon (e.g. -33.9249, 18.4241)" class="px-3 py-1 rounded border text-sm w-64">
                                <button onclick="handleManualLocation()" class="text-emerald-700">üíæ Save</button>
                                <button onclick="state.editingLocation=false;render();" class="text-gray-500">‚ùå</button>
                            ` : `
                                <span>${state.location.name}</span>
                                <button onclick="state.editingLocation=true;state.locationInput='';render();" class="text-emerald-500">‚úèÔ∏è</button>
                            `}
                        </div>
                        
                        <button onclick="detectLocation()" ${state.detectingLocation?'disabled':''} class="bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 mb-3 disabled:opacity-50">
                            üìç ${state.detectingLocation ? 'Detecting...' : 'Auto-Detect Location'}
                        </button>
                        
                        <div class="mb-3">
                            <button onclick="toggleNotifications()" class="px-4 py-2 rounded-lg ${state.notificationsEnabled?'bg-emerald-600 text-white':'bg-gray-300 text-gray-700'}">
                                ${state.notificationsEnabled?'üîî Athan: ON':'üîï Athan: OFF'}
                            </button>
                        </div>
                        
                        <div class="text-emerald-700 text-lg">${state.currentTime.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}</div>
                        
                        <div class="mt-4 relative inline-block">
                            <button onclick="state.showMethodMenu=!state.showMethodMenu;render();" class="bg-white text-emerald-700 px-4 py-2 rounded-lg shadow">
                                ‚öôÔ∏è ${calculationMethods[state.selectedMethod].name} ${state.showMethodMenu?'‚ñ≤':'‚ñº'}
                            </button>
                            ${state.showMethodMenu?`
                                <div class="absolute top-full mt-2 left-1/2 transform -translate-x-1/2 bg-white rounded-lg shadow-xl border z-10 w-96">
                                    ${Object.keys(calculationMethods).map(k=>`
                                        <button onclick="state.selectedMethod='${k}';state.showMethodMenu=false;calculatePrayerTimes();render();" 
                                            class="w-full text-left px-4 py-3 hover:bg-emerald-50 text-sm border-b ${state.selectedMethod===k?'bg-emerald-100 font-bold text-emerald-700':''}">
                                            ${calculationMethods[k].name}
                                        </button>
                                    `).join('')}
                                </div>
                            `:''}
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                        <div class="flex items-center justify-center gap-3">
                            <span class="text-3xl">üïê</span>
                            <div class="text-5xl font-bold text-emerald-800">${state.currentTime.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',second:'2-digit'})}</div>
                        </div>
                    </div>

                    ${state.nextPrayer?`
                        <div class="bg-gradient-to-r from-emerald-600 to-teal-600 rounded-2xl shadow-lg p-6 mb-6 text-white">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-2xl">üîî</span>
                                <h2 class="text-xl font-semibold">Next Prayer</h2>
                            </div>
                            <div class="text-4xl font-bold mb-2">${state.nextPrayer.name}</div>
                            <div class="text-2xl mb-2">${display12Hour(state.nextPrayer.time)}</div>
                            <div class="text-lg opacity-90">in ${state.nextPrayer.hoursLeft}h ${state.nextPrayer.minutesLeft}m</div>
                        </div>
                    `:''}

                    <div class="bg-white rounded-2xl shadow-lg overflow-hidden mb-6">
                        ${prayers.map((p,i)=>{
                            const isNext = state.nextPrayer && state.nextPrayer.name===p;
                            return `
                                <div class="flex justify-between items-center p-5 ${i<4?'border-b':''}  ${isNext?'bg-emerald-50':''}">
                                    <div class="flex items-center gap-3">
                                        <div class="w-12 h-12 rounded-full flex items-center justify-center ${isNext?'bg-emerald-600 text-white':'bg-emerald-100 text-emerald-700'}">
                                            <span class="font-bold text-xl">${p[0]}</span>
                                        </div>
                                        <div class="font-semibold text-lg ${isNext?'text-emerald-700':'text-gray-800'}">${p}</div>
                                    </div>
                                    <div class="text-2xl font-bold ${isNext?'text-emerald-700':'text-gray-700'}">${display12Hour(state.prayerTimes[p])}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>

                    <div class="text-center text-emerald-600 text-sm pb-8">
                        <p class="mb-2">‚ú® Times calculated for your location</p>
                        <p class="text-xs opacity-75">üìç ${state.location.lat.toFixed(4)}¬∞, ${state.location.lon.toFixed(4)}¬∞</p>
                        <button onclick="playAthan()" class="mt-3 text-xs bg-emerald-100 px-3 py-1 rounded hover:bg-emerald-200">üîî Test Athan</button>
                    </div>
                </div>
            `;

            if (state.editingLocation) {
                const input = document.getElementById('locInput');
                if (input) {
                    input.focus();
                    input.oninput = (e) => state.locationInput = e.target.value;
                    input.onkeypress = (e) => { if(e.key==='Enter') handleManualLocation(); };
                }
            }
        }

        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        // Initialize
        loadSavedLocation();
        calculatePrayerTimes();
        render();
        requestNotificationPermission();

        // Update every second
        setInterval(() => {
            state.currentTime = new Date();
            const prevNext = state.nextPrayer ? state.nextPrayer.name : null;
            calculateNextPrayer();
            const newNext = state.nextPrayer ? state.nextPrayer.name : null;
            if (prevNext !== newNext) render();
            checkPrayerTime();
            render();
        }, 1000);

        // Recalculate at midnight
        const now = new Date();
        const tomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
        setTimeout(() => {
            calculatePrayerTimes();
            render();
            setInterval(() => { calculatePrayerTimes(); render(); }, 24*60*60*1000);
        }, tomorrow - now);
    </script>
</body>
</html>
